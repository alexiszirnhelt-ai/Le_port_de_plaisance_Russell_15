<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRUD Reservations - Port de Plaisance Russell</title>
  <link rel="stylesheet" href="/css/reservations.css">
</head>
<body>
  <main class="container">
    <div class="topbar">
      <h1>Gestion des reservations</h1>
      <a href="/dashboard" class="back-link">Retour au dashboard</a>
    </div>

    <section class="card">
      <h2 id="form-title">Creer une reservation</h2>
      <form id="reservation-form">
        <input type="hidden" id="reservation-id">

        <label for="catwayNumber">Numero catway</label>
        <input type="number" id="catwayNumber" min="1" required>

        <label for="clientName">Nom client</label>
        <input type="text" id="clientName" required>

        <label for="boatName">Nom bateau</label>
        <input type="text" id="boatName" required>

        <label for="checkIn">Date arrivee</label>
        <input type="date" id="checkIn" required>

        <label for="checkOut">Date depart</label>
        <input type="date" id="checkOut" required>

        <div class="actions">
          <button type="submit" id="submit-btn">Creer</button>
          <button type="button" id="cancel-btn" class="secondary" hidden>Annuler</button>
        </div>
      </form>
      <p id="form-message"></p>
    </section>

    <section class="card">
      <h2>Liste des reservations</h2>
      <table>
        <thead>
          <tr>
            <th>Catway</th>
            <th>Client</th>
            <th>Bateau</th>
            <th>Arrivee</th>
            <th>Depart</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="reservations-body">
          <tr><td colspan="6">Chargement...</td></tr>
        </tbody>
      </table>
      <p id="table-message"></p>
    </section>
  </main>

  <script>
    const form = document.getElementById('reservation-form');
    const formTitle = document.getElementById('form-title');
    const submitBtn = document.getElementById('submit-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const formMessage = document.getElementById('form-message');
    const tableMessage = document.getElementById('table-message');
    const reservationsBody = document.getElementById('reservations-body');

    const fields = {
      id: document.getElementById('reservation-id'),
      catwayNumber: document.getElementById('catwayNumber'),
      clientName: document.getElementById('clientName'),
      boatName: document.getElementById('boatName'),
      checkIn: document.getElementById('checkIn'),
      checkOut: document.getElementById('checkOut'),
    };

    let reservationsCache = [];

    function toInputDate(value) {
      return new Date(value).toISOString().slice(0, 10);
    }

    function toDisplayDate(value) {
      return new Date(value).toLocaleDateString('fr-FR');
    }

    function resetForm() {
      fields.id.value = '';
      fields.catwayNumber.value = '';
      fields.clientName.value = '';
      fields.boatName.value = '';
      fields.checkIn.value = '';
      fields.checkOut.value = '';
      formTitle.textContent = 'Creer une reservation';
      submitBtn.textContent = 'Creer';
      cancelBtn.hidden = true;
    }

    function fillForm(reservation) {
      fields.id.value = reservation._id;
      fields.catwayNumber.value = reservation.catwayNumber;
      fields.clientName.value = reservation.clientName;
      fields.boatName.value = reservation.boatName;
      fields.checkIn.value = toInputDate(reservation.checkIn);
      fields.checkOut.value = toInputDate(reservation.checkOut);
      formTitle.textContent = 'Modifier une reservation';
      submitBtn.textContent = 'Mettre a jour';
      cancelBtn.hidden = false;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function loadReservations() {
      tableMessage.textContent = '';
      try {
        const response = await fetch('/reservations');
        if (!response.ok) {
          throw new Error('Erreur API');
        }

        reservationsCache = await response.json();
        if (!reservationsCache.length) {
          reservationsBody.innerHTML = '<tr><td colspan="6">Aucune reservation.</td></tr>';
          return;
        }

        reservationsBody.innerHTML = reservationsCache.map((reservation) => `
          <tr>
            <td>${reservation.catwayNumber}</td>
            <td>${reservation.clientName}</td>
            <td>${reservation.boatName}</td>
            <td>${toDisplayDate(reservation.checkIn)}</td>
            <td>${toDisplayDate(reservation.checkOut)}</td>
            <td>
              <button type="button" data-action="show" data-id="${reservation._id}">Details</button>
              <button type="button" data-action="edit" data-id="${reservation._id}">Modifier</button>
              <button type="button" data-action="delete" data-id="${reservation._id}" class="danger">Supprimer</button>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        reservationsBody.innerHTML = '<tr><td colspan="6">Impossible de charger les reservations.</td></tr>';
      }
    }

    async function createReservation(payload) {
      const response = await fetch('/reservations', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      if (!response.ok) {
        const data = await response.json().catch(() => ({}));
        throw new Error(data.message || 'Echec de creation');
      }
    }

    async function updateReservation(id, payload) {
      const response = await fetch(`/reservations/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      if (!response.ok) {
        const data = await response.json().catch(() => ({}));
        throw new Error(data.message || 'Echec de mise a jour');
      }
    }

    async function deleteReservation(id) {
      const response = await fetch(`/reservations/${id}`, { method: 'DELETE' });
      if (!response.ok) {
        const data = await response.json().catch(() => ({}));
        throw new Error(data.message || 'Echec de suppression');
      }
    }

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      formMessage.textContent = '';

      const payload = {
        catwayNumber: Number(fields.catwayNumber.value),
        clientName: fields.clientName.value.trim(),
        boatName: fields.boatName.value.trim(),
        checkIn: fields.checkIn.value,
        checkOut: fields.checkOut.value,
      };

      try {
        if (fields.id.value) {
          await updateReservation(fields.id.value, payload);
          formMessage.textContent = 'Reservation mise a jour.';
        } else {
          await createReservation(payload);
          formMessage.textContent = 'Reservation creee.';
        }
        resetForm();
        await loadReservations();
      } catch (error) {
        formMessage.textContent = error.message;
      }
    });

    cancelBtn.addEventListener('click', () => {
      formMessage.textContent = '';
      resetForm();
    });

    reservationsBody.addEventListener('click', async (event) => {
      const button = event.target.closest('button[data-id]');
      if (!button) return;

      const id = button.dataset.id;
      const action = button.dataset.action;
      const reservation = reservationsCache.find((item) => item._id === id);

      if (!reservation) return;

      if (action === 'show') {
        tableMessage.textContent = `Reservation ${reservation.clientName} - catway ${reservation.catwayNumber} (${toDisplayDate(reservation.checkIn)} au ${toDisplayDate(reservation.checkOut)})`;
        return;
      }

      if (action === 'edit') {
        fillForm(reservation);
        tableMessage.textContent = '';
        return;
      }

      if (action === 'delete') {
        const confirmed = window.confirm(`Supprimer la reservation de ${reservation.clientName} ?`);
        if (!confirmed) return;

        try {
          await deleteReservation(id);
          tableMessage.textContent = 'Reservation supprimee.';
          if (fields.id.value === id) {
            resetForm();
          }
          await loadReservations();
        } catch (error) {
          tableMessage.textContent = error.message;
        }
      }
    });

    resetForm();
    loadReservations();
  </script>
</body>
</html>

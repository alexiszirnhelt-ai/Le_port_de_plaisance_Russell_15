<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tableau de bord - Port de Plaisance Russell</title>
  <link rel="stylesheet" href="/css/dashboard.css">
</head>
<body>
  <main class="container">
    <div class="topbar">
      <h1>Tableau de bord</h1>
    </div>

    <nav class="menu card">
      <a href="/dashboard">Accueil</a>
      <a href="/dashboard/catways">CRUD catways</a>
      <a href="/dashboard/reservations">CRUD reservations</a>
      <a href="/dashboard/users">CRUD utilisateurs</a>
      <a href="/api-docs">Documentation API</a>
      <form action="/logout" method="post">
        <button type="submit" class="logout-btn">
          <svg class="logout-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M10 17l5-5-5-5M15 12H4M14 4h4a2 2 0 012 2v12a2 2 0 01-2 2h-4" />
          </svg>
          Se deconnecter
        </button>
      </form>
    </nav>

    <section class="meta info-grid">
      <div class="card">
        <div class="label">Nom</div>
        <div class="value"><%= userName %></div>
      </div>
      <div class="card">
        <div class="label">Email</div>
        <div class="value"><%= userEmail %></div>
      </div>
      <div class="card">
        <div class="label">Date du jour</div>
        <div class="value"><%= new Date(currentDate).toLocaleDateString('fr-FR') %></div>
      </div>
    </section>

    <h2>Reservations en cours</h2>
    <table>
      <thead>
        <tr>
          <th>Catway</th>
          <th>Client</th>
          <th>Bateau</th>
          <th>Arrivee</th>
          <th>Depart</th>
        </tr>
      </thead>
      <tbody id="reservations-body">
        <tr>
          <td colspan="5">Chargement des reservations...</td>
        </tr>
      </tbody>
    </table>
    <p id="error">Impossible de charger les reservations.</p>
  </main>

  <script>
    async function loadCurrentReservations() {
      const tbody = document.getElementById('reservations-body');

      try {
        const response = await fetch('/reservations');
        if (!response.ok) {
          throw new Error('Erreur de chargement');
        }

        const reservations = await response.json();
        const now = new Date();

        const activeReservations = reservations.filter((reservation) => {
          const checkIn = new Date(reservation.checkIn);
          const checkOut = new Date(reservation.checkOut);
          return checkIn <= now && checkOut >= now;
        });

        if (activeReservations.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5">Aucune reservation en cours.</td></tr>';
          return;
        }

        tbody.innerHTML = activeReservations.map((reservation) => `
          <tr>
            <td>${reservation.catwayNumber}</td>
            <td>${reservation.clientName}</td>
            <td>${reservation.boatName}</td>
            <td>${new Date(reservation.checkIn).toLocaleDateString('fr-FR')}</td>
            <td>${new Date(reservation.checkOut).toLocaleDateString('fr-FR')}</td>
          </tr>
        `).join('');
      } catch (error) {
        document.getElementById('error').style.display = 'block';
        tbody.innerHTML = '<tr><td colspan="5">Impossible de charger les reservations.</td></tr>';
      }
    }

    loadCurrentReservations();
  </script>
</body>
</html>
